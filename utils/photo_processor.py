# -*- coding: utf-8 -*-
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ –µ–¥—ã
"""
import re
import logging
from typing import Optional, Dict, Any, List

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏–∑ main.py
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from utils.calorie_calculator import ask_gpt, extract_nutrition_smart, validate_calorie_result
from utils.nutrition_validator import validate_nutrition_data
from data.calorie_database import CALORIE_DATABASE


async def analyze_food_photo(image_base64: str) -> Dict[str, Any]:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –µ–¥—ã —á–µ—Ä–µ–∑ GPT Vision"""
    prompt = f"""–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –§–û–¢–û –ï–î–´ –ò –†–ê–°–°–ß–ò–¢–ê–ô –ö–ê–õ–û–†–ò–ô–ù–û–°–¢–¨ –ü–û–®–ê–ì–û–í–û:

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ —Ñ–æ—Ç–æ (—Ç–∞–±–ª–µ—Ç–∫–∏, –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Å–∞–ª—Ñ–µ—Ç–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ç.–¥.). 
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ï–î–£ –ò –ù–ê–ü–ò–¢–ö–ò –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ/–≤ –ø–æ—Å—É–¥–µ!

üìã –®–ê–ì 1 - –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï:
–ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û —Å: "–ù–∞ —Ñ–æ—Ç–æ [–Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–ª—é–¥–∞]: [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 1], [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 2], [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 3] –∏ —Ç.–¥."

üìä –®–ê–ì 2 - –¢–û–ß–ù–´–ô –†–ê–°–ß–ï–¢ –ö–ê–ñ–î–û–ì–û –ò–ù–ì–†–ï–î–ò–ï–ù–¢–ê:
–ò—Å–ø–æ–ª—å–∑—É–π —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {CALORIE_DATABASE}

üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–ê–í–ò–õ–¨–ù–´–ï –ö–ê–õ–û–†–ò–ô–ù–û–°–¢–ò –ù–ê 100–≥:
‚Ä¢ –ü–æ–º–∏–¥–æ—Ä—ã —Å–≤–µ–∂–∏–µ: 20 –∫–∫–∞–ª/100–≥, 1–≥ –±–µ–ª–∫–∞, 0.2–≥ –∂–∏—Ä–∞, 4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –û–≥—É—Ä—Ü—ã —Å–≤–µ–∂–∏–µ: 15 –∫–∫–∞–ª/100–≥, 0.8–≥ –±–µ–ª–∫–∞, 0.1–≥ –∂–∏—Ä–∞, 3–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ú–∞—Å–ª–∏–Ω—ã/–æ–ª–∏–≤–∫–∏: 115-145 –∫–∫–∞–ª/100–≥, 1–≥ –±–µ–ª–∫–∞, 11-15–≥ –∂–∏—Ä–∞, 6–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –°—ã—Ä —Ñ–µ—Ç–∞: 264 –∫–∫–∞–ª/100–≥, 14–≥ –±–µ–ª–∫–∞, 21–≥ –∂–∏—Ä–∞, 4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ú–∞–π–æ–Ω–µ–∑ 67%: 621 –∫–∫–∞–ª/100–≥, 2–≥ –±–µ–ª–∫–∞, 67–≥ –∂–∏—Ä–∞
‚Ä¢ –°–º–µ—Ç–∞–Ω–∞ 20%: 206 –∫–∫–∞–ª/100–≥, 2.8–≥ –±–µ–ª–∫–∞, 20–≥ –∂–∏—Ä–∞
‚Ä¢ –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ: 884 –∫–∫–∞–ª/100–≥, 0–≥ –±–µ–ª–∫–∞, 100–≥ –∂–∏—Ä–∞
‚Ä¢ –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞: 165 –∫–∫–∞–ª/100–≥, 31–≥ –±–µ–ª–∫–∞, 3.6–≥ –∂–∏—Ä–∞
‚Ä¢ –†–∏—Å/–±—É–ª–≥—É—Ä –≤–∞—Ä–µ–Ω—ã–π: 116 –∫–∫–∞–ª/100–≥, 2.2–≥ –±–µ–ª–∫–∞, 0.5–≥ –∂–∏—Ä–∞, 23–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ú–∞–∫–∞—Ä–æ–Ω—ã –≤–∞—Ä–µ–Ω—ã–µ: 112 –∫–∫–∞–ª/100–≥, 3.5–≥ –±–µ–ª–∫–∞, 0.4–≥ –∂–∏—Ä–∞, 23–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏: 134 –∫–∫–∞–ª/100–≥, 1.2–≥ –±–µ–ª–∫–∞, 8.9–≥ –∂–∏—Ä–∞, 12–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

‚ö†Ô∏è –¢–ò–ü–ò–ß–ù–´–ï –ü–û–†–¶–ò–ò - –û–¶–ï–ù–ò–í–ê–ô –†–ï–ê–õ–¨–ù–û:
‚Ä¢ –¢–∞—Ä–µ–ª–∫–∞ —Å–∞–ª–∞—Ç–∞: 200-350–≥
‚Ä¢ –ü–æ—Ä—Ü–∏—è –æ–≤–æ—â–µ–π –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ: –∫–∞–∂–¥—ã–π –≤–∏–¥ ~80-150–≥
‚Ä¢ –ü–æ—Ä—Ü–∏—è —Å—ã—Ä–∞ —Ñ–µ—Ç–∞ –≤ —Å–∞–ª–∞—Ç–µ: 30-60–≥
‚Ä¢ –ó–∞–ø—Ä–∞–≤–∫–∞ (–º–∞–π–æ–Ω–µ–∑/—Å–º–µ—Ç–∞–Ω–∞): 30-50–≥ (2-3 —Å—Ç.–ª.)
‚Ä¢ –¢–∞—Ä–µ–ª–∫–∞ –º–∞–∫–∞—Ä–æ–Ω/—Ä–∏—Å–∞ —Å –≥–∞—Ä–Ω–∏—Ä–æ–º: 250-400–≥
‚Ä¢ –°–∞–ª–∞—Ç –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ (–æ—Ç–¥–µ–ª—å–Ω–æ): 100-150–≥

üßÆ –®–ê–ì 3 - –†–ê–°–ß–ï–¢ –ü–û–†–¶–ò–ò:
–î–ª—è –ö–ê–ñ–î–û–ì–û –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:
"[–ù–∞–∑–≤–∞–Ω–∏–µ] ~[–≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö]–≥: [–∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 100–≥] √ó [–≤–µ—Å/100] = [–∏—Ç–æ–≥–æ –∫–∫–∞–ª], –ë:[–±–µ–ª–∫–∏]–≥, –ñ:[–∂–∏—Ä—ã]–≥, –£:[—É–≥–ª–µ–≤–æ–¥—ã]–≥"

–ü–†–ò–ú–ï–† –î–õ–Ø –ì–†–ï–ß–ï–°–ö–û–ì–û –°–ê–õ–ê–¢–ê (—Ç–∞—Ä–µ–ª–∫–∞ ~300–≥):
"–ü–æ–º–∏–¥–æ—Ä—ã ~120–≥: 20 √ó 1.2 = 24 –∫–∫–∞–ª, –ë:1.2–≥, –ñ:0.2–≥, –£:4.8–≥
–û–≥—É—Ä—Ü—ã ~100–≥: 15 √ó 1.0 = 15 –∫–∫–∞–ª, –ë:0.8–≥, –ñ:0.1–≥, –£:3–≥
–°—ã—Ä —Ñ–µ—Ç–∞ ~50–≥: 264 √ó 0.5 = 132 –∫–∫–∞–ª, –ë:7–≥, –ñ:10.5–≥, –£:2–≥
–ú–∞—Å–ª–∏–Ω—ã ~30–≥: 115 √ó 0.3 = 35 –∫–∫–∞–ª, –ë:0.3–≥, –ñ:3.3–≥, –£:1.8–≥
–ú–∞–π–æ–Ω–µ–∑/—Å–º–µ—Ç–∞–Ω–∞ ~40–≥: 621 √ó 0.4 = 248 –∫–∫–∞–ª, –ë:0.8–≥, –ñ:26.8–≥, –£:1.2–≥

–ò–¢–û–ì–û: 454 –∫–∫–∞–ª, 10.1 –≥ –±–µ–ª–∫–∞, 40.9 –≥ –∂–∏—Ä–æ–≤, 12.8 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–ü–†–ò–ú–ï–† –î–õ–Ø –ú–ê–ö–ê–†–û–ù –° –ú–Ø–°–û–ú –ò –°–ê–õ–ê–¢–û–ú:
"–ú–∞–∫–∞—Ä–æ–Ω—ã –≤–∞—Ä–µ–Ω—ã–µ ~200–≥: 112 √ó 2.0 = 224 –∫–∫–∞–ª, –ë:7–≥, –ñ:0.8–≥, –£:46–≥
–ú—è—Å–Ω–æ–π —Ñ–∞—Ä—à/–∫–æ—Ç–ª–µ—Ç–∞ ~100–≥: 250 √ó 1.0 = 250 –∫–∫–∞–ª, –ë:17–≥, –ñ:20–≥, –£:0–≥
–ö–µ—Ç—á—É–ø ~30–≥: 93 √ó 0.3 = 28 –∫–∫–∞–ª, –ë:0.3–≥, –ñ:0–≥, –£:7–≥
–ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ ~120–≥: 134 √ó 1.2 = 161 –∫–∫–∞–ª, –ë:1.4–≥, –ñ:10.7–≥, –£:14.4–≥

–ò–¢–û–ì–û: 663 –∫–∫–∞–ª, 25.7 –≥ –±–µ–ª–∫–∞, 31.5 –≥ –∂–∏—Ä–æ–≤, 67.4 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

üíØ –®–ê–ì 4 - –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
–ü–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—å:
1. ‚úÖ –°—É–º–º–∞ –≤—Å–µ—Ö –∫–∞–ª–æ—Ä–∏–π = –ò–¢–û–ì–û –∫–∞–ª–æ—Ä–∏–π
2. ‚úÖ –°—É–º–º–∞ –≤—Å–µ—Ö –ë = –ò–¢–û–ì–û –±–µ–ª–∫–∞
3. ‚úÖ –°—É–º–º–∞ –≤—Å–µ—Ö –ñ = –ò–¢–û–ì–û –∂–∏—Ä–æ–≤  
4. ‚úÖ –°—É–º–º–∞ –≤—Å–µ—Ö –£ = –ò–¢–û–ì–û —É–≥–ª–µ–≤–æ–¥–æ–≤

üö® –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
‚Ä¢ –°–∞–ª–∞—Ç —Å –∑–∞–ø—Ä–∞–≤–∫–æ–π –í–°–ï–ì–î–ê –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π –∏–∑-–∑–∞ –º–∞—Å–ª–∞/–º–∞–π–æ–Ω–µ–∑–∞/—Å–º–µ—Ç–∞–Ω—ã!
‚Ä¢ –ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç —Å —Ñ–µ—Ç–æ–π –∏ –∑–∞–ø—Ä–∞–≤–∫–æ–π = 350-500 –∫–∫–∞–ª (–ù–ï 150-200!)
‚Ä¢ –ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ = ~134 –∫–∫–∞–ª/100–≥ (—Ç–∞–º –ú–ê–°–õ–û!)
‚Ä¢ –ù–ï –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–∞–≤–∫–∏ - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–∞–ª–æ—Ä–∏–π –≤ —Å–∞–ª–∞—Ç–∞—Ö!

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ—è—Å–Ω–æ - –∑–∞–¥–∞–π –û–î–ò–ù –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Å "–í–û–ü–†–û–°:".
"""

    messages = [{
        'role': 'user',
        'content': [
            {'type': 'text', 'text': prompt},
            {'type': 'image_url', 'image_url': {'url': f'data:image/jpeg;base64,{image_base64}'}}
        ]
    }]

    try:
        response = await ask_gpt(messages)
        logging.info(f"GPT photo analysis response: {response}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–∫–∞–∑ GPT (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω—ã–π –æ—Ç–∫–∞–∑ –±–µ–∑ —Ä–∞—Å—á–µ—Ç–æ–≤)
        refusal_phrases = ['–∏–∑–≤–∏–Ω–∏—Ç–µ', '–Ω–µ –º–æ–≥—É', '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ', '–Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏']
        has_refusal = any(phrase in response.lower() for phrase in refusal_phrases)
        has_calculations = '–∫–∫–∞–ª' in response.lower() or '–∫–∞–ª–æ—Ä' in response.lower()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–∞–∑ –ò –Ω–µ—Ç —Ä–∞—Å—á–µ—Ç–æ–≤
        if has_refusal and not has_calculations:
            logging.warning(f"GPT refused to analyze photo: {response[:200]}")
            return {'error': 'GPT –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ'}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–¥–∞–ª –ª–∏ GPT –≤–æ–ø—Ä–æ—Å
        if "–í–û–ü–†–û–°:" in response:
            question = response.replace("–í–û–ü–†–û–°:", "").strip()
            return {'question': question}

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
        nutrition = extract_nutrition_smart(response)
        description = extract_description_from_photo_response(response)

        # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üìä –ò–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ GPT: –∫–∞–ª–æ—Ä–∏–∏={nutrition['calories']}, –±–µ–ª–∫–∏={nutrition['protein']}, –∂–∏—Ä—ã={nutrition['fat']}, —É–≥–ª–µ–≤–æ–¥—ã={nutrition['carbs']}")
        logging.info(f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}")

        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏, –Ω–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç - –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        if not nutrition['calories'] and response:
            logging.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º. –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç GPT:\n{response}")
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ò–¢–û–ì–û –≤—Ä—É—á–Ω—É—é
            itogo_match = re.search(r'–ò–¢–û–ì–û[:\s]+(\d+)\s*–∫–∫–∞–ª', response, re.IGNORECASE)
            if itogo_match:
                nutrition['calories'] = int(itogo_match.group(1))
                logging.info(f"‚úÖ –ù–∞—à–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –ò–¢–û–ì–û: {nutrition['calories']}")

        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üîç –ù–ê–ß–ê–õ–û –í–ê–õ–ò–î–ê–¶–ò–ò –¥–ª—è '{description}'")
        logging.info(f"üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {nutrition}")

        if nutrition['calories'] or nutrition['protein']:
            nutrition = validate_nutrition_data(nutrition, description)
            logging.info(f"üîç –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {nutrition}")

        if nutrition['calories'] and description:
            # validate_nutrition_data —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –∏ –∏—Å–ø—Ä–∞–≤–∏–ª –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–ñ–£
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ù–ï –Ω—É–∂–Ω–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            logging.info(f"üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: {nutrition['calories']} –∫–∫–∞–ª")
            result = {
                'description': description,
                'calories': nutrition['calories'],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                'success': True
            }

            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ë–ñ–£ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã
            if nutrition['protein'] is not None:
                result['protein'] = round(nutrition['protein'], 1)
            if nutrition['fat'] is not None:
                result['fat'] = round(nutrition['fat'], 1)
            if nutrition['carbs'] is not None:
                result['carbs'] = round(nutrition['carbs'], 1)

            return result
        else:
            logging.error(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ.\n–û—Ç–≤–µ—Ç GPT:\n{response}")
            return {
                'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –±–ª—é–¥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º.',
                'debug_response': response[:500]  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            }

    except Exception as e:
        logging.error(f"Error analyzing photo: {e}")
        return {'error': f'–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ: {str(e)}'}


def extract_calories_from_photo_response(response: str) -> Optional[int]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT –ø–æ —Ñ–æ—Ç–æ"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–ª–æ–≤ "–∏—Ç–æ–≥–æ", "–≤—Å–µ–≥–æ", "–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å"
    total_match = re.search(r'(?:–∏—Ç–æ–≥–æ|–≤—Å–µ–≥–æ|–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å)[^0-9]*(\d+)', response, re.IGNORECASE)
    if total_match:
        return int(total_match.group(1))

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ "–∏—Ç–æ–≥–æ", –±–µ—Ä–µ–º –≤—Å–µ —á–∏—Å–ª–∞ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª—å—à–µ–µ
    numbers = [int(x) for x in re.findall(r'\d+', response)]
    if numbers:
        return max(numbers)  # –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å

    return None


def extract_description_from_photo_response(response: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT"""
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É "–ù–∞ —Ñ–æ—Ç–æ..." –¥–æ –ø–µ—Ä–≤–æ–≥–æ –®–ê–ì–∞, —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    match = re.search(r'–ù–∞ —Ñ–æ—Ç–æ (.+?)(?=\n\n|üìä|–®–ê–ì|~\d+–≥:|–ò–¢–û–ì–û:|–†–∞—Å—á–µ—Ç|$)', response, re.IGNORECASE | re.DOTALL)
    if match:
        description = match.group(1).strip()
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        description = re.sub(r'üìä.*$', '', description)  # —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ üìä
        description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', description)  # —É–±–∏—Ä–∞–µ–º "–†–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π.."
        description = re.sub(r'\.$', '', description)  # —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ
        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        description = re.sub(r'\s+', ' ', description)
        return description.strip()

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
    lines = response.split('\n')
    description_lines = []

    for i, line in enumerate(lines):
        line = line.strip()
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
        if not line or line.startswith(('üìã', 'üìä', 'üíØ', 'üéØ')):
            continue
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ —Ä–∞—Å—á—ë—Ç–∞—Ö –∏–ª–∏ —à–∞–≥–∞—Ö
        if any(keyword in line for keyword in ['–®–ê–ì', '~', '–≥:', '–ò–¢–û–ì–û', '165√ó', '116√ó', '–†–∞—Å—á–µ—Ç']):
            break
        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è
        if len(line) > 5:
            description_lines.append(line)

    if description_lines:
        full_description = ' '.join(description_lines)
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        full_description = re.sub(r'^[üìãüìäüíØüéØ\-\s]*', '', full_description)
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        full_description = re.sub(r'üìä.*$', '', full_description)
        full_description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', full_description)
        return full_description.strip()

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    return "–ë–ª—é–¥–æ —Å —Ñ–æ—Ç–æ"


def extract_ingredients_from_description(description: str) -> List[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –±–ª—é–¥–∞"""
    # –£–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤–æ–µ —Å–ª–æ–≤–æ (—Ç–≤–æ—Ä–æ–≥, —Å–∞–ª–∞—Ç –∏ —Ç.–¥.) –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ "—Å"
    if ' —Å ' in description:
        parts = description.split(' —Å ', 1)
        if len(parts) > 1:
            ingredients_part = parts[1]
            # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ —Å–æ—é–∑–∞–º
            ingredients = re.split(r',|\s+–∏\s+', ingredients_part)
            return [ing.strip() for ing in ingredients if ing.strip()]

    return []


def get_base_dish_from_description(description: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤–æ–µ –±–ª—é–¥–æ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è"""
    if ' —Å ' in description:
        return description.split(' —Å ')[0].strip()
    return description.strip()
