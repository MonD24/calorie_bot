# -*- coding: utf-8 -*-
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ –µ–¥—ã
"""
import re
import logging
from typing import Optional, Dict, Any, List

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏–∑ main.py
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from utils.calorie_calculator import ask_gpt, extract_nutrition_smart, validate_calorie_result
from utils.nutrition_validator import validate_nutrition_data
from data.calorie_database import CALORIE_DATABASE


async def analyze_food_photo(image_base64: str) -> Dict[str, Any]:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –µ–¥—ã —á–µ—Ä–µ–∑ GPT Vision"""
    prompt = f"""–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –§–û–¢–û –ï–î–´ –ò –†–ê–°–°–ß–ò–¢–ê–ô –ö–ê–õ–û–†–ò–ô–ù–û–°–¢–¨ –ü–û–®–ê–ì–û–í–û:

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: 
- –ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –ù–ï–°–ö–û–õ–¨–ö–û –¢–ê–†–ï–õ–û–ö/–ë–õ–Æ–î - –ø–æ—Å—á–∏—Ç–∞–π –ö–ê–ñ–î–û–ï –û–¢–î–ï–õ–¨–ù–û –∏ —Å–ª–æ–∂–∏ –≤ –æ–±—â–∏–π –∏—Ç–æ–≥!
- –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã (—Ç–∞–±–ª–µ—Ç–∫–∏, —Å–∞–ª—Ñ–µ—Ç–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω). –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ï–î–£!

üìã –®–ê–ì 1 - –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï:
–ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –ù–ï–°–ö–û–õ–¨–ö–û –±–ª—é–¥/—Ç–∞—Ä–µ–ª–æ–∫, –æ–ø–∏—à–∏ –ö–ê–ñ–î–û–ï:
"–ù–∞ —Ñ–æ—Ç–æ –¥–≤–∞ –±–ª—é–¥–∞:
1) [–ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ]: [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã]
2) [–≤—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ]: [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã]"

–ï—Å–ª–∏ –û–î–ù–û –±–ª—é–¥–æ: "–ù–∞ —Ñ–æ—Ç–æ [–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞]: [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã]"

üìä –®–ê–ì 2 - –†–ê–°–ß–ï–¢ –ö–ê–ñ–î–û–ì–û –ë–õ–Æ–î–ê –û–¢–î–ï–õ–¨–ù–û:
{CALORIE_DATABASE}

üî¥ –í–ê–ñ–ù–´–ï –ö–ê–õ–û–†–ò–ô–ù–û–°–¢–ò –ù–ê 100–≥:
‚Ä¢ –ú–∞–∫–∞—Ä–æ–Ω—ã –≤–∞—Ä–µ–Ω—ã–µ: 112 –∫–∫–∞–ª, 3.5–≥ –±–µ–ª–∫–∞, 0.4–≥ –∂–∏—Ä–∞, 23–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ö–æ—Ç–ª–µ—Ç–∞ –∂–∞—Ä–µ–Ω–∞—è (–º—è—Å–Ω–∞—è): 220-280 –∫–∫–∞–ª, 15-18–≥ –±–µ–ª–∫–∞, 15-20–≥ –∂–∏—Ä–∞
‚Ä¢ –ö–æ—Ç–ª–µ—Ç–∞ –∫—É—Ä–∏–Ω–∞—è: 190 –∫–∫–∞–ª, 18–≥ –±–µ–ª–∫–∞, 10–≥ –∂–∏—Ä–∞
‚Ä¢ –ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏: 134 –∫–∫–∞–ª, 1.2–≥ –±–µ–ª–∫–∞, 8.9–≥ –∂–∏—Ä–∞, 12–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –†—ã–±–∞ –∂–∞—Ä–µ–Ω–∞—è: 180-220 –∫–∫–∞–ª, 20–≥ –±–µ–ª–∫–∞, 10-15–≥ –∂–∏—Ä–∞
‚Ä¢ –°–µ–ª–µ–¥–∫–∞/—Å–∫—É–º–±—Ä–∏—è: 200-250 –∫–∫–∞–ª, 18–≥ –±–µ–ª–∫–∞, 15-18–≥ –∂–∏—Ä–∞

‚ö†Ô∏è –¢–ò–ü–ò–ß–ù–´–ï –ü–û–†–¶–ò–ò:
‚Ä¢ –¢–∞—Ä–µ–ª–∫–∞ –º–∞–∫–∞—Ä–æ–Ω: 150-200–≥ –≤–∞—Ä–µ–Ω—ã—Ö = 170-225 –∫–∫–∞–ª
‚Ä¢ 2 –∫–æ—Ç–ª–µ—Ç—ã —Å—Ä–µ–¥–Ω–∏—Ö: ~150–≥ = 330-400 –∫–∫–∞–ª
‚Ä¢ –ü–æ—Ä—Ü–∏—è –º–æ—Ä–∫–æ–≤–∏ –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏: 100-150–≥ = 134-200 –∫–∫–∞–ª
‚Ä¢ –ü–æ—Ä—Ü–∏—è —Ä—ã–±—ã: 100-150–≥ = 200-300 –∫–∫–∞–ª
‚Ä¢ –°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã: 0 –∫–∫–∞–ª

üßÆ –®–ê–ì 3 - –†–ê–°–ß–ï–¢ –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ë–õ–Æ–î–ê:
**–ë–õ–Æ–î–û 1 (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞–∫–∞—Ä–æ–Ω—ã —Å –∫–æ—Ç–ª–µ—Ç–∞–º–∏):**
–ú–∞–∫–∞—Ä–æ–Ω—ã ~180–≥: 112 √ó 1.8 = 202 –∫–∫–∞–ª, –ë:6.3–≥, –ñ:0.7–≥, –£:41–≥
–ö–æ—Ç–ª–µ—Ç—ã 2—à—Ç ~150–≥: 250 √ó 1.5 = 375 –∫–∫–∞–ª, –ë:25–≥, –ñ:28–≥, –£:5–≥
–ü–æ–¥—ã—Ç–æ–≥ –±–ª—é–¥–∞ 1: 577 –∫–∫–∞–ª, 31.3–≥ –±–µ–ª–∫–∞, 28.7–≥ –∂–∏—Ä–æ–≤, 46–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

**–ë–õ–Æ–î–û 2 (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ —Å —Ä—ã–±–æ–π):**
–ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ ~120–≥: 134 √ó 1.2 = 161 –∫–∫–∞–ª, –ë:1.4–≥, –ñ:10.7–≥, –£:14.4–≥
–†—ã–±–∞ ~100–≥: 200 √ó 1.0 = 200 –∫–∫–∞–ª, –ë:20–≥, –ñ:12–≥, –£:0–≥
–ü–æ–¥—ã—Ç–æ–≥ –±–ª—é–¥–∞ 2: 361 –∫–∫–∞–ª, 21.4–≥ –±–µ–ª–∫–∞, 22.7–≥ –∂–∏—Ä–æ–≤, 14.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

üíØ –®–ê–ì 4 - –û–ë–©–ò–ô –ò–¢–û–ì (–°–£–ú–ú–ê –í–°–ï–• –ë–õ–Æ–î):
–ò–¢–û–ì–û: 938 –∫–∫–∞–ª, 52.7 –≥ –±–µ–ª–∫–∞, 51.4 –≥ –∂–∏—Ä–æ–≤, 60.4 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

üö® –ü–†–ê–í–ò–õ–ê:
‚Ä¢ –ö–æ—Ç–ª–µ—Ç—ã –í–°–ï–ì–î–ê –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–µ (–∂–∞—Ä–µ–Ω—ã–µ –≤ –º–∞—Å–ª–µ)!
‚Ä¢ 2 –∫–æ—Ç–ª–µ—Ç—ã = –º–∏–Ω–∏–º—É–º 300-400 –∫–∫–∞–ª
‚Ä¢ –ú–æ—Ä–∫–æ–≤—å –ø–æ-–∫–æ—Ä–µ–π—Å–∫–∏ –∫–∞–ª–æ—Ä–∏–π–Ω–∞—è –∏–∑-–∑–∞ –ú–ê–°–õ–ê!
‚Ä¢ –ï—Å–ª–∏ –≤–∏–¥–∏—à—å 2 —Ç–∞—Ä–µ–ª–∫–∏ - –∏—Ç–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 500+ –∫–∫–∞–ª!
‚Ä¢ –ù–ï –æ–±—ä–µ–¥–∏–Ω—è–π —Ä–∞–∑–Ω—ã–µ —Ç–∞—Ä–µ–ª–∫–∏ –≤ –æ–¥–Ω–æ –±–ª—é–¥–æ - —Å—á–∏—Ç–∞–π –æ—Ç–¥–µ–ª—å–Ω–æ!

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ—è—Å–Ω–æ - –∑–∞–¥–∞–π –û–î–ò–ù –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Å "–í–û–ü–†–û–°:".
"""

    messages = [{
        'role': 'user',
        'content': [
            {'type': 'text', 'text': prompt},
            {'type': 'image_url', 'image_url': {'url': f'data:image/jpeg;base64,{image_base64}'}}
        ]
    }]

    try:
        response = await ask_gpt(messages)
        logging.info(f"GPT photo analysis response: {response}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–∫–∞–∑ GPT (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω—ã–π –æ—Ç–∫–∞–∑ –±–µ–∑ —Ä–∞—Å—á–µ—Ç–æ–≤)
        refusal_phrases = ['–∏–∑–≤–∏–Ω–∏—Ç–µ', '–Ω–µ –º–æ–≥—É', '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ', '–Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏']
        has_refusal = any(phrase in response.lower() for phrase in refusal_phrases)
        has_calculations = '–∫–∫–∞–ª' in response.lower() or '–∫–∞–ª–æ—Ä' in response.lower()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–∞–∑ –ò –Ω–µ—Ç —Ä–∞—Å—á–µ—Ç–æ–≤
        if has_refusal and not has_calculations:
            logging.warning(f"GPT refused to analyze photo: {response[:200]}")
            return {'error': 'GPT –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ'}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–¥–∞–ª –ª–∏ GPT –≤–æ–ø—Ä–æ—Å
        if "–í–û–ü–†–û–°:" in response:
            question = response.replace("–í–û–ü–†–û–°:", "").strip()
            return {'question': question}

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
        nutrition = extract_nutrition_smart(response)
        description = extract_description_from_photo_response(response)

        # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üìä –ò–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ GPT: –∫–∞–ª–æ—Ä–∏–∏={nutrition['calories']}, –±–µ–ª–∫–∏={nutrition['protein']}, –∂–∏—Ä—ã={nutrition['fat']}, —É–≥–ª–µ–≤–æ–¥—ã={nutrition['carbs']}")
        logging.info(f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}")

        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏, –Ω–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç - –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        if not nutrition['calories'] and response:
            logging.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º. –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç GPT:\n{response}")
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ò–¢–û–ì–û –≤—Ä—É—á–Ω—É—é
            itogo_match = re.search(r'–ò–¢–û–ì–û[:\s]+(\d+)\s*–∫–∫–∞–ª', response, re.IGNORECASE)
            if itogo_match:
                nutrition['calories'] = int(itogo_match.group(1))
                logging.info(f"‚úÖ –ù–∞—à–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –ò–¢–û–ì–û: {nutrition['calories']}")

        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üîç –ù–ê–ß–ê–õ–û –í–ê–õ–ò–î–ê–¶–ò–ò –¥–ª—è '{description}'")
        logging.info(f"üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {nutrition}")

        if nutrition['calories'] or nutrition['protein']:
            nutrition = validate_nutrition_data(nutrition, description)
            logging.info(f"üîç –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {nutrition}")

        if nutrition['calories'] and description:
            # validate_nutrition_data —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –∏ –∏—Å–ø—Ä–∞–≤–∏–ª –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–ñ–£
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ù–ï –Ω—É–∂–Ω–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            logging.info(f"üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: {nutrition['calories']} –∫–∫–∞–ª")
            result = {
                'description': description,
                'calories': nutrition['calories'],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                'success': True
            }

            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ë–ñ–£ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã
            if nutrition['protein'] is not None:
                result['protein'] = round(nutrition['protein'], 1)
            if nutrition['fat'] is not None:
                result['fat'] = round(nutrition['fat'], 1)
            if nutrition['carbs'] is not None:
                result['carbs'] = round(nutrition['carbs'], 1)

            return result
        else:
            logging.error(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ.\n–û—Ç–≤–µ—Ç GPT:\n{response}")
            return {
                'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –±–ª—é–¥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º.',
                'debug_response': response[:500]  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            }

    except Exception as e:
        logging.error(f"Error analyzing photo: {e}")
        return {'error': f'–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ: {str(e)}'}


def extract_calories_from_photo_response(response: str) -> Optional[int]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT –ø–æ —Ñ–æ—Ç–æ"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–ª–æ–≤ "–∏—Ç–æ–≥–æ", "–≤—Å–µ–≥–æ", "–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å"
    total_match = re.search(r'(?:–∏—Ç–æ–≥–æ|–≤—Å–µ–≥–æ|–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å)[^0-9]*(\d+)', response, re.IGNORECASE)
    if total_match:
        return int(total_match.group(1))

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ "–∏—Ç–æ–≥–æ", –±–µ—Ä–µ–º –≤—Å–µ —á–∏—Å–ª–∞ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª—å—à–µ–µ
    numbers = [int(x) for x in re.findall(r'\d+', response)]
    if numbers:
        return max(numbers)  # –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å

    return None


def extract_description_from_photo_response(response: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª—é–¥
    multiple_dishes_match = re.search(r'–ù–∞ —Ñ–æ—Ç–æ (–¥–≤–∞|—Ç—Ä–∏|2|3|–Ω–µ—Å–∫–æ–ª—å–∫–æ) –±–ª—é–¥[–∞-—è]*[:\s]*\n?(1\)|‚Ä¢|\d\.)', response, re.IGNORECASE)
    
    if multiple_dishes_match or '–ë–õ–Æ–î–û 1' in response.upper() or '1)' in response:
        # –≠—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª—é–¥ - —Å–æ–±–∏—Ä–∞–µ–º –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è
        dishes = []
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±–ª—é–¥–∞ –ø–æ –Ω–æ–º–µ—Ä–∞–º
        dish_patterns = [
            r'(?:–ë–õ–Æ–î–û\s*)?1[).\s:]+([^2\n]+?)(?=\n|–ë–õ–Æ–î–û|2\)|$)',
            r'(?:–ë–õ–Æ–î–û\s*)?2[).\s:]+([^3\n]+?)(?=\n|–ë–õ–Æ–î–û|3\)|$)',
        ]
        
        for pattern in dish_patterns:
            match = re.search(pattern, response, re.IGNORECASE)
            if match:
                dish_desc = match.group(1).strip()
                # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
                dish_desc = re.sub(r'[üìäüíØüßÆ\*]+.*$', '', dish_desc)
                dish_desc = re.sub(r'\s+', ' ', dish_desc).strip()
                if dish_desc and len(dish_desc) > 3:
                    dishes.append(dish_desc)
        
        if len(dishes) >= 2:
            return f"1) {dishes[0]}; 2) {dishes[1]}"
        elif dishes:
            return dishes[0]
    
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É "–ù–∞ —Ñ–æ—Ç–æ..." –¥–æ –ø–µ—Ä–≤–æ–≥–æ –®–ê–ì–∞, —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    match = re.search(r'–ù–∞ —Ñ–æ—Ç–æ (.+?)(?=\n\n|üìä|–®–ê–ì|~\d+–≥:|–ò–¢–û–ì–û:|–†–∞—Å—á–µ—Ç|–ë–õ–Æ–î–û\s*\d|$)', response, re.IGNORECASE | re.DOTALL)
    if match:
        description = match.group(1).strip()
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        description = re.sub(r'üìä.*$', '', description)  # —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ üìä
        description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', description)  # —É–±–∏—Ä–∞–µ–º "–†–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π.."
        description = re.sub(r'\.$', '', description)  # —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ
        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        description = re.sub(r'\s+', ' ', description)
        return description.strip()

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
    lines = response.split('\n')
    description_lines = []

    for i, line in enumerate(lines):
        line = line.strip()
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
        if not line or line.startswith(('üìã', 'üìä', 'üíØ', 'üéØ')):
            continue
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ —Ä–∞—Å—á—ë—Ç–∞—Ö –∏–ª–∏ —à–∞–≥–∞—Ö
        if any(keyword in line for keyword in ['–®–ê–ì', '~', '–≥:', '–ò–¢–û–ì–û', '165√ó', '116√ó', '–†–∞—Å—á–µ—Ç', '–ë–õ–Æ–î–û 1', '–ë–õ–Æ–î–û 2']):
            break
        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è
        if len(line) > 5:
            description_lines.append(line)

    if description_lines:
        full_description = ' '.join(description_lines)
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        full_description = re.sub(r'^[üìãüìäüíØüéØ\-\s]*', '', full_description)
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        full_description = re.sub(r'üìä.*$', '', full_description)
        full_description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', full_description)
        return full_description.strip()

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    return "–ë–ª—é–¥–æ —Å —Ñ–æ—Ç–æ"


def extract_ingredients_from_description(description: str) -> List[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –±–ª—é–¥–∞"""
    # –£–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤–æ–µ —Å–ª–æ–≤–æ (—Ç–≤–æ—Ä–æ–≥, —Å–∞–ª–∞—Ç –∏ —Ç.–¥.) –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ "—Å"
    if ' —Å ' in description:
        parts = description.split(' —Å ', 1)
        if len(parts) > 1:
            ingredients_part = parts[1]
            # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ —Å–æ—é–∑–∞–º
            ingredients = re.split(r',|\s+–∏\s+', ingredients_part)
            return [ing.strip() for ing in ingredients if ing.strip()]

    return []


def get_base_dish_from_description(description: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤–æ–µ –±–ª—é–¥–æ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è"""
    if ' —Å ' in description:
        return description.split(' —Å ')[0].strip()
    return description.strip()
