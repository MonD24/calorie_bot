# -*- coding: utf-8 -*-
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ –µ–¥—ã
"""
import re
import logging
from typing import Optional, Dict, Any, List

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏–∑ main.py
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from utils.calorie_calculator import ask_gpt, extract_nutrition_smart, validate_calorie_result
from utils.nutrition_validator import validate_nutrition_data
from data.calorie_database import CALORIE_DATABASE


async def analyze_food_photo(image_base64: str) -> Dict[str, Any]:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –µ–¥—ã —á–µ—Ä–µ–∑ GPT Vision"""
    prompt = f"""–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –§–û–¢–û –ï–î–´ –ò –†–ê–°–°–ß–ò–¢–ê–ô –ö–ê–õ–û–†–ò–ô–ù–û–°–¢–¨ –ü–û–®–ê–ì–û–í–û:

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ —Ñ–æ—Ç–æ (—Ç–∞–±–ª–µ—Ç–∫–∏, –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Å–∞–ª—Ñ–µ—Ç–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ç.–¥.). 
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ï–î–£ –ò –ù–ê–ü–ò–¢–ö–ò –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ/–≤ –ø–æ—Å—É–¥–µ!

üìã –®–ê–ì 1 - –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï:
–ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û —Å: "–ù–∞ —Ñ–æ—Ç–æ [–Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–ª—é–¥–∞]: [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 1], [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 2], [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 3] –∏ —Ç.–¥."

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–ü–ò–°–ê–ù–ò–Ø:
"–ù–∞ —Ñ–æ—Ç–æ –∫—É—Ä–∏–Ω–æ–µ –±–ª—é–¥–æ —Å –≥–∞—Ä–Ω–∏—Ä–æ–º: –∂–∞—Ä–µ–Ω–∞—è –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞, –æ—Ç–≤–∞—Ä–Ω–æ–π —Ä–∏—Å, –≤–∞—Ä–µ–Ω–æ–µ —è–π—Ü–æ, –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—É—Ä—Ü—ã, –±–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü"

–í–ê–ñ–ù–û: –ü–µ—Ä–µ—á–∏—Å–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –í–°–ï –≤–∏–¥–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ!

üìä –®–ê–ì 2 - –†–ê–°–ß–ï–¢ –ö–ê–ñ–î–û–ì–û –ò–ù–ì–†–ï–î–ò–ï–ù–¢–ê:
–ò—Å–ø–æ–ª—å–∑—É–π —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {CALORIE_DATABASE}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–°–ù–û–í–ù–´–ï –ü–†–û–î–£–ö–¢–´:
‚Ä¢ –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞: 165 –∫–∫–∞–ª/100–≥, 31–≥ –±–µ–ª–∫–∞, 3.6–≥ –∂–∏—Ä–∞
‚Ä¢ –¢—É–Ω–µ—Ü –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –º–∞—Å–ª–µ: 231 –∫–∫–∞–ª/100–≥, 27–≥ –±–µ–ª–∫–∞, 13–≥ –∂–∏—Ä–∞ (—Å–≤–µ—Ç–ª—ã–µ –∫—É—Å–æ—á–∫–∏ –≤ —Å–∞–ª–∞—Ç–µ)
‚Ä¢ –¢—É–Ω–µ—Ü –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–æ–∫—É: 96 –∫–∫–∞–ª/100–≥, 21–≥ –±–µ–ª–∫–∞, 1–≥ –∂–∏—Ä–∞
‚Ä¢ –†–∏—Å/–±—É–ª–≥—É—Ä –≤–∞—Ä–µ–Ω—ã–π: 116 –∫–∫–∞–ª/100–≥, 2.2–≥ –±–µ–ª–∫–∞, 0.5–≥ –∂–∏—Ä–∞, 23–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –æ—Ç–≤–∞—Ä–Ω–æ–π: 77 –∫–∫–∞–ª/100–≥, 2–≥ –±–µ–ª–∫–∞, 0.1–≥ –∂–∏—Ä–∞, 16–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –Ø–π—Ü–æ –≤–∞—Ä–µ–Ω–æ–µ: 155 –∫–∫–∞–ª/100–≥ (1 —Ü–µ–ª–æ–µ —è–π—Ü–æ ~70–∫–∫–∞–ª, 7–≥ –±–µ–ª–∫–∞)
‚Ä¢ –û–≥—É—Ä—Ü—ã —Å–≤–µ–∂–∏–µ/–º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ: 15-16 –∫–∫–∞–ª/100–≥, 0.8–≥ –±–µ–ª–∫–∞
‚Ä¢ –ú–∞–π–æ–Ω–µ–∑ 67%: 621 –∫–∫–∞–ª/100–≥, 2–≥ –±–µ–ª–∫–∞, 67–≥ –∂–∏—Ä–∞ (1 —Å—Ç.–ª. = ~15–≥ = 93–∫–∫–∞–ª)
‚Ä¢ –°—É—Ö–∞—Ä–∏–∫–∏/–≥—Ä–µ–Ω–∫–∏: 330 –∫–∫–∞–ª/100–≥, 9–≥ –±–µ–ª–∫–∞, 10–≥ –∂–∏—Ä–∞, 52–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
‚Ä¢ –ö—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞: 252 –∫–∫–∞–ª/100–≥, 24.6–≥ –±–µ–ª–∫–∞, 17.9–≥ –∂–∏—Ä–∞
‚Ä¢ –°—ã—Ä —Å–ª–∏–≤–æ—á–Ω—ã–π (–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è): 253 –∫–∫–∞–ª/100–≥, 5.5–≥ –±–µ–ª–∫–∞, 24–≥ –∂–∏—Ä–∞
‚Ä¢ –ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ: 748 –∫–∫–∞–ª/100–≥, 0.5–≥ –±–µ–ª–∫–∞, 83–≥ –∂–∏—Ä–∞

‚ö†Ô∏è –ö–ê–ö –û–¢–õ–ò–ß–ò–¢–¨ –¢–£–ù–ï–¶ –û–¢ –ö–£–†–ò–¶–´ –í –°–ê–õ–ê–¢–ï:
‚Ä¢ –¢–£–ù–ï–¶: —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–µ/–±–µ–ª—ã–µ –∫—É—Å–æ—á–∫–∏, —Å–ª–æ–∏—Å—Ç–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞, —á–∞—Å—Ç–æ —Å–º–µ—à–∞–Ω —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ –≤ —Å–∞–ª–∞—Ç–µ
‚Ä¢ –ö–£–†–ò–¶–ê: –∂–µ–ª—Ç–æ–≤–∞—Ç–æ-–±–µ–ª—ã–µ –∫—É—Å–æ—á–∫–∏, –≤–æ–ª–æ–∫–Ω–∏—Å—Ç–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞, –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–µ –∫—É—Å–∫–∏
‚Ä¢ –ï—Å–ª–∏ —Å–∞–ª–∞—Ç —Å –ú–ê–ô–û–ù–ï–ó–û–ú –∏ —Å–≤–µ—Ç–ª—ã–º–∏ –∫—É—Å–æ—á–∫–∞–º–∏ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¢–£–ù–ï–¶!
‚Ä¢ –ï—Å–ª–∏ –≤ —Å–∞–ª–∞—Ç–µ –µ—Å—Ç—å –Ø–ô–¶–ê, –û–ì–£–†–¶–´, –°–£–•–ê–†–ò–ö–ò + –±–µ–ª—ã–µ –∫—É—Å–æ—á–∫–∏ - —ç—Ç–æ —Å–∞–ª–∞—Ç —Å –¢–£–ù–¶–û–ú

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞–∂–∏ —Ä–∞—Å—á–µ—Ç:
"[–ù–∞–∑–≤–∞–Ω–∏–µ] ~[—Ä–µ–∞–ª—å–Ω—ã–π_–≤–µ—Å]–≥: [–∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 100–≥] √ó [–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç] = [–∏—Ç–æ–≥–æ –∫–∫–∞–ª], [–±–µ–ª–∫–∏]–≥ –±–µ–ª–∫–∞, [–∂–∏—Ä—ã]–≥ –∂–∏—Ä–∞, [—É–≥–ª–µ–≤–æ–¥—ã]–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–û–¶–ï–ù–ö–ê –í–ï–°–ê –ü–û –§–û–¢–û:
‚Ä¢ –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –≤ —Ç–∞—Ä–µ–ª–∫–µ: –æ–±—ã—á–Ω–æ 100-150–≥
‚Ä¢ –ü–æ—Ä—Ü–∏—è –≥–∞—Ä–Ω–∏—Ä–∞ (—Ä–∏—Å/–±—É–ª–≥—É—Ä): 100-150–≥
‚Ä¢ –í–∞—Ä–µ–Ω–æ–µ —è–π—Ü–æ: 1 —à—Ç—É–∫–∞ = 50–≥
‚Ä¢ –ú–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—É—Ä—Ü—ã: 3-4 —à—Ç—É–∫–∏ = 60-80–≥
‚Ä¢ –ë—É—Ç–µ—Ä–±—Ä–æ–¥ —Å –∏–∫—Ä–æ–π (1 —à—Ç): —Ö–ª–µ–± ~30–≥ (80 –∫–∫–∞–ª) + –º–∞—Å–ª–æ/—Å—ã—Ä ~10-15–≥ (75-38 –∫–∫–∞–ª) + –∏–∫—Ä–∞ ~20-25–≥ (50-63 –∫–∫–∞–ª) = 180-200 –∫–∫–∞–ª –∑–∞ —à—Ç—É–∫—É

‚ö†Ô∏è –í–ê–ñ–ù–û –î–õ–Ø –ë–£–¢–ï–†–ë–†–û–î–û–í –° –ò–ö–†–û–ô:
‚Ä¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–û–°–ß–ò–¢–ê–ô –ö–û–õ–ò–ß–ï–°–¢–í–û –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ!
‚Ä¢ 5-6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ = 900-1200 –∫–∫–∞–ª (–û–ß–ï–ù–¨ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–µ –±–ª—é–¥–æ!)
‚Ä¢ –ù–ï —É–∫–∞–∑—ã–≤–∞–π –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –Ω–∞ 100–≥, –∞ —Å—á–∏—Ç–∞–π –û–ë–©–£–Æ —Å—É–º–º—É –≤—Å–µ—Ö –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤!

–û–¶–ï–ù–ö–ê –û–ë–™–ï–ú–ê –ù–ê–ü–ò–¢–ö–û–í –ü–û –§–û–¢–û:
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ù–ï–î–û–û–¶–ï–ù–ò–í–ê–ô –û–ë–™–ï–ú –ù–ê–ü–ò–¢–ö–û–í!
‚Ä¢ –ú–∞–ª–µ–Ω—å–∫–∏–π —Å—Ç–∞–∫–∞–Ω/—Ä—é–º–∫–∞ = 50-100 –º–ª
‚Ä¢ –û–±—ã—á–Ω—ã–π —Å—Ç–∞–∫–∞–Ω = 200-250 –º–ª
‚Ä¢ –ë–æ–ª—å—à–æ–π —Å—Ç–∞–∫–∞–Ω/–±–æ–∫–∞–ª = 300-400 –º–ª
‚Ä¢ –ü–∏–≤–Ω–æ–π –±–æ–∫–∞–ª = 300-500 –º–ª (—á–∞—â–µ –≤—Å–µ–≥–æ 300-400 –º–ª!)
‚Ä¢ –ë—É—Ç—ã–ª–∫–∞ –ø–∏–≤–∞ = 330-500 –º–ª
‚Ä¢ –ë–æ–∫–∞–ª –≤–∏–Ω–∞ = 150-200 –º–ª
‚Ä¢ –ß–∞—à–∫–∞ –∫–æ—Ñ–µ = 200-250 –º–ª

–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –ü–ò–í–ê:
‚Ä¢ –ü–∏–≤–æ —Å–≤–µ—Ç–ª–æ–µ = 42 –∫–∫–∞–ª –Ω–∞ 100 –º–ª
‚Ä¢ –ë–æ–∫–∞–ª 300 –º–ª = 126 –∫–∫–∞–ª
‚Ä¢ –ë–æ–∫–∞–ª 400 –º–ª = 168 –∫–∫–∞–ª
‚Ä¢ –ë—É—Ç—ã–ª–∫–∞ 500 –º–ª = 210 –∫–∫–∞–ª

üíØ –®–ê–ì 3 - –ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê:
"–ò–¢–û–ì–û: [—Å—É–º–º–∞ –∫–∞–ª–æ—Ä–∏–π] –∫–∫–∞–ª, [—Å—É–º–º–∞ –±–µ–ª–∫–æ–≤] –≥ –±–µ–ª–∫–∞, [—Å—É–º–º–∞ –∂–∏—Ä–æ–≤] –≥ –∂–∏—Ä–æ–≤, [—Å—É–º–º–∞ —É–≥–ª–µ–≤–æ–¥–æ–≤] –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

üéØ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
‚úÖ –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ –í–°–ï –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–∞ —Ç–∞—Ä–µ–ª–∫–µ
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
‚úÖ –î–ª—è –±–ª—é–¥–∞ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 300+ –∫–∫–∞–ª
‚úÖ –ù–ï –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤!

–ü—Ä–∏–º–µ—Ä –¥–ª—è —Å–∞–ª–∞—Ç–∞ —Å —Ç—É–Ω—Ü–æ–º:
"–ù–∞ —Ñ–æ—Ç–æ —Å–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º - –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—É–Ω–µ—Ü –≤ –º–∞—Å–ª–µ, –æ—Ç–≤–∞—Ä–Ω–æ–π –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –∫—É–±–∏–∫–∞–º–∏, –≤–∞—Ä–µ–Ω–æ–µ —è–π—Ü–æ, –æ–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ, —Å—É—Ö–∞—Ä–∏–∫–∏, –º–∞–π–æ–Ω–µ–∑.

–¢—É–Ω–µ—Ü –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –º–∞—Å–ª–µ ~80–≥: 231√ó0.8 = 185 –∫–∫–∞–ª, 21.6–≥ –±–µ–ª–∫–∞, 10.4–≥ –∂–∏—Ä–æ–≤, 0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –æ—Ç–≤–∞—Ä–Ω–æ–π ~100–≥: 77√ó1.0 = 77 –∫–∫–∞–ª, 2–≥ –±–µ–ª–∫–∞, 0.1–≥ –∂–∏—Ä–æ–≤, 16–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–Ø–π—Ü–æ –≤–∞—Ä–µ–Ω–æ–µ ~50–≥: 155√ó0.5 = 78 –∫–∫–∞–ª, 6.5–≥ –±–µ–ª–∫–∞, 5.5–≥ –∂–∏—Ä–æ–≤, 0.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–û–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ ~40–≥: 16√ó0.4 = 6 –∫–∫–∞–ª, 0.3–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 1–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–°—É—Ö–∞—Ä–∏–∫–∏ ~25–≥: 330√ó0.25 = 83 –∫–∫–∞–ª, 2.3–≥ –±–µ–ª–∫–∞, 2.5–≥ –∂–∏—Ä–æ–≤, 13–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ú–∞–π–æ–Ω–µ–∑ ~30–≥: 621√ó0.3 = 186 –∫–∫–∞–ª, 0.6–≥ –±–µ–ª–∫–∞, 20–≥ –∂–∏—Ä–æ–≤, 1–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 615 –∫–∫–∞–ª, 33.3 –≥ –±–µ–ª–∫–∞, 38.5 –≥ –∂–∏—Ä–æ–≤, 31.4 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–ü—Ä–∏–º–µ—Ä –¥–ª—è –∫—É—Ä–∏–Ω–æ–≥–æ –±–ª—é–¥–∞:
"–ù–∞ —Ñ–æ—Ç–æ –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å —Ä–∏—Å–æ–º –∏ –æ–≤–æ—â–∞–º–∏ - –∫—É—Å–æ—á–∫–∏ –∂–∞—Ä–µ–Ω–æ–π –∫—É—Ä–∏—Ü—ã, –ø–æ—Ä—Ü–∏—è –æ—Ç–≤–∞—Ä–Ω–æ–≥–æ —Ä–∏—Å–∞, –≤–∞—Ä–µ–Ω–æ–µ —è–π—Ü–æ, –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—É—Ä—Ü—ã.

–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –∂–∞—Ä–µ–Ω–∞—è ~120–≥: 165√ó1.2√ó1.2 = 238 –∫–∫–∞–ª, 37–≥ –±–µ–ª–∫–∞, 5–≥ –∂–∏—Ä–æ–≤, 0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–†–∏—Å –æ—Ç–≤–∞—Ä–Ω–æ–π ~100–≥: 116√ó1.0 = 116 –∫–∫–∞–ª, 2.2–≥ –±–µ–ª–∫–∞, 0.5–≥ –∂–∏—Ä–æ–≤, 23–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–Ø–π—Ü–æ –≤–∞—Ä–µ–Ω–æ–µ ~50–≥: 155√ó0.5 = 78 –∫–∫–∞–ª, 6.5–≥ –±–µ–ª–∫–∞, 5.5–≥ –∂–∏—Ä–æ–≤, 0.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–û–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ ~60–≥: 16√ó0.6 = 10 –∫–∫–∞–ª, 0.5–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 2–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 442 –∫–∫–∞–ª, 46.2 –≥ –±–µ–ª–∫–∞, 11 –≥ –∂–∏—Ä–æ–≤, 25.4 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–ü—Ä–∏–º–µ—Ä –¥–ª—è –Ω–∞–ø–∏—Ç–∫–∞:
"–ù–∞ —Ñ–æ—Ç–æ –±–æ–∫–∞–ª —Å–≤–µ—Ç–ª–æ–≥–æ –ø–∏–≤–∞, –∑–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 350 –º–ª (–±–æ–ª—å—à–æ–π –±–æ–∫–∞–ª).

–ü–∏–≤–æ —Å–≤–µ—Ç–ª–æ–µ 4-5% ~350–º–ª: 42√ó3.5 = 147 –∫–∫–∞–ª, 1.75–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 12.6–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 147 –∫–∫–∞–ª, 1.75 –≥ –±–µ–ª–∫–∞, 0 –≥ –∂–∏—Ä–æ–≤, 12.6 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–ü—Ä–∏–º–µ—Ä –¥–ª—è –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∏–∫—Ä–æ–π:
"–ù–∞ —Ñ–æ—Ç–æ 6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä–æ–π - –ª–æ–º—Ç–∏–∫–∏ –±–µ–ª–æ–≥–æ —Ö–ª–µ–±–∞ —Å–æ —Å–ª–∏–≤–æ—á–Ω—ã–º —Å—ã—Ä–æ–º –∏ –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä–æ–π.

–ë–µ–ª—ã–π —Ö–ª–µ–± 6 –ª–æ–º—Ç–∏–∫–æ–≤ ~180–≥ (6√ó30–≥): 265√ó1.8 = 477 –∫–∫–∞–ª, 14.4–≥ –±–µ–ª–∫–∞, 5.4–≥ –∂–∏—Ä–æ–≤, 88.2–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–°—ã—Ä —Å–ª–∏–≤–æ—á–Ω—ã–π ~75–≥ (6√ó12–≥): 253√ó0.75 = 190 –∫–∫–∞–ª, 4.1–≥ –±–µ–ª–∫–∞, 18–≥ –∂–∏—Ä–æ–≤, 3.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞ ~135–≥ (6√ó22–≥): 252√ó1.35 = 340 –∫–∫–∞–ª, 33.2–≥ –±–µ–ª–∫–∞, 24.2–≥ –∂–∏—Ä–æ–≤, 0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 1007 –∫–∫–∞–ª, 51.7 –≥ –±–µ–ª–∫–∞, 47.6 –≥ –∂–∏—Ä–æ–≤, 91.6 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ—è—Å–Ω–æ - –∑–∞–¥–∞–π –û–î–ò–ù –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Å "–í–û–ü–†–û–°:".
"""

    messages = [{
        'role': 'user',
        'content': [
            {'type': 'text', 'text': prompt},
            {'type': 'image_url', 'image_url': {'url': f'data:image/jpeg;base64,{image_base64}'}}
        ]
    }]

    try:
        response = await ask_gpt(messages)
        logging.info(f"GPT photo analysis response: {response}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–∫–∞–∑ GPT (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω—ã–π –æ—Ç–∫–∞–∑ –±–µ–∑ —Ä–∞—Å—á–µ—Ç–æ–≤)
        refusal_phrases = ['–∏–∑–≤–∏–Ω–∏—Ç–µ', '–Ω–µ –º–æ–≥—É', '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ', '–Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏']
        has_refusal = any(phrase in response.lower() for phrase in refusal_phrases)
        has_calculations = '–∫–∫–∞–ª' in response.lower() or '–∫–∞–ª–æ—Ä' in response.lower()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–∞–∑ –ò –Ω–µ—Ç —Ä–∞—Å—á–µ—Ç–æ–≤
        if has_refusal and not has_calculations:
            logging.warning(f"GPT refused to analyze photo: {response[:200]}")
            return {'error': 'GPT –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ'}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–¥–∞–ª –ª–∏ GPT –≤–æ–ø—Ä–æ—Å
        if "–í–û–ü–†–û–°:" in response:
            question = response.replace("–í–û–ü–†–û–°:", "").strip()
            return {'question': question}

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
        nutrition = extract_nutrition_smart(response)
        description = extract_description_from_photo_response(response)

        # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üìä –ò–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ GPT: –∫–∞–ª–æ—Ä–∏–∏={nutrition['calories']}, –±–µ–ª–∫–∏={nutrition['protein']}, –∂–∏—Ä—ã={nutrition['fat']}, —É–≥–ª–µ–≤–æ–¥—ã={nutrition['carbs']}")
        logging.info(f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}")

        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏, –Ω–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç - –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        if not nutrition['calories'] and response:
            logging.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º. –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç GPT:\n{response}")
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ò–¢–û–ì–û –≤—Ä—É—á–Ω—É—é
            itogo_match = re.search(r'–ò–¢–û–ì–û[:\s]+(\d+)\s*–∫–∫–∞–ª', response, re.IGNORECASE)
            if itogo_match:
                nutrition['calories'] = int(itogo_match.group(1))
                logging.info(f"‚úÖ –ù–∞—à–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –ò–¢–û–ì–û: {nutrition['calories']}")

        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        logging.info(f"üîç –ù–ê–ß–ê–õ–û –í–ê–õ–ò–î–ê–¶–ò–ò –¥–ª—è '{description}'")
        logging.info(f"üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {nutrition}")

        if nutrition['calories'] or nutrition['protein']:
            nutrition = validate_nutrition_data(nutrition, description)
            logging.info(f"üîç –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {nutrition}")

        if nutrition['calories'] and description:
            # validate_nutrition_data —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –∏ –∏—Å–ø—Ä–∞–≤–∏–ª –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–ñ–£
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ù–ï –Ω—É–∂–Ω–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            logging.info(f"üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: {nutrition['calories']} –∫–∫–∞–ª")
            result = {
                'description': description,
                'calories': nutrition['calories'],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                'success': True
            }

            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ë–ñ–£ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã
            if nutrition['protein'] is not None:
                result['protein'] = round(nutrition['protein'], 1)
            if nutrition['fat'] is not None:
                result['fat'] = round(nutrition['fat'], 1)
            if nutrition['carbs'] is not None:
                result['carbs'] = round(nutrition['carbs'], 1)

            return result
        else:
            logging.error(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ.\n–û—Ç–≤–µ—Ç GPT:\n{response}")
            return {
                'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –±–ª—é–¥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º.',
                'debug_response': response[:500]  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            }

    except Exception as e:
        logging.error(f"Error analyzing photo: {e}")
        return {'error': f'–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ: {str(e)}'}


def extract_calories_from_photo_response(response: str) -> Optional[int]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT –ø–æ —Ñ–æ—Ç–æ"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–ª–æ–≤ "–∏—Ç–æ–≥–æ", "–≤—Å–µ–≥–æ", "–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å"
    total_match = re.search(r'(?:–∏—Ç–æ–≥–æ|–≤—Å–µ–≥–æ|–æ–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å)[^0-9]*(\d+)', response, re.IGNORECASE)
    if total_match:
        return int(total_match.group(1))

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ "–∏—Ç–æ–≥–æ", –±–µ—Ä–µ–º –≤—Å–µ —á–∏—Å–ª–∞ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª—å—à–µ–µ
    numbers = [int(x) for x in re.findall(r'\d+', response)]
    if numbers:
        return max(numbers)  # –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å

    return None


def extract_description_from_photo_response(response: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT"""
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É "–ù–∞ —Ñ–æ—Ç–æ..." –¥–æ –ø–µ—Ä–≤–æ–≥–æ –®–ê–ì–∞, —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    match = re.search(r'–ù–∞ —Ñ–æ—Ç–æ (.+?)(?=\n\n|üìä|–®–ê–ì|~\d+–≥:|–ò–¢–û–ì–û:|–†–∞—Å—á–µ—Ç|$)', response, re.IGNORECASE | re.DOTALL)
    if match:
        description = match.group(1).strip()
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        description = re.sub(r'üìä.*$', '', description)  # —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ üìä
        description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', description)  # —É–±–∏—Ä–∞–µ–º "–†–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π.."
        description = re.sub(r'\.$', '', description)  # —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ
        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        description = re.sub(r'\s+', ' ', description)
        return description.strip()

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
    lines = response.split('\n')
    description_lines = []

    for i, line in enumerate(lines):
        line = line.strip()
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
        if not line or line.startswith(('üìã', 'üìä', 'üíØ', 'üéØ')):
            continue
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ —Ä–∞—Å—á—ë—Ç–∞—Ö –∏–ª–∏ —à–∞–≥–∞—Ö
        if any(keyword in line for keyword in ['–®–ê–ì', '~', '–≥:', '–ò–¢–û–ì–û', '165√ó', '116√ó', '–†–∞—Å—á–µ—Ç']):
            break
        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è
        if len(line) > 5:
            description_lines.append(line)

    if description_lines:
        full_description = ' '.join(description_lines)
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        full_description = re.sub(r'^[üìãüìäüíØüéØ\-\s]*', '', full_description)
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ
        full_description = re.sub(r'üìä.*$', '', full_description)
        full_description = re.sub(r'\s*–†–∞—Å—á–µ—Ç.*$', '', full_description)
        return full_description.strip()

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    return "–ë–ª—é–¥–æ —Å —Ñ–æ—Ç–æ"


def extract_ingredients_from_description(description: str) -> List[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –±–ª—é–¥–∞"""
    # –£–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤–æ–µ —Å–ª–æ–≤–æ (—Ç–≤–æ—Ä–æ–≥, —Å–∞–ª–∞—Ç –∏ —Ç.–¥.) –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ "—Å"
    if ' —Å ' in description:
        parts = description.split(' —Å ', 1)
        if len(parts) > 1:
            ingredients_part = parts[1]
            # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ —Å–æ—é–∑–∞–º
            ingredients = re.split(r',|\s+–∏\s+', ingredients_part)
            return [ing.strip() for ing in ingredients if ing.strip()]

    return []


def get_base_dish_from_description(description: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤–æ–µ –±–ª—é–¥–æ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è"""
    if ' —Å ' in description:
        return description.split(' —Å ')[0].strip()
    return description.strip()
