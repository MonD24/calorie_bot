# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ë–ñ–£ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT
"""
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from utils.calorie_calculator import extract_nutrition_smart


def test_extract_final_values_from_detailed_response():
    """
    –¢–µ—Å—Ç –Ω–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ò–¢–û–ì–û–í–´–• –∑–Ω–∞—á–µ–Ω–∏–π –ë–ñ–£, –∞ –Ω–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö
    """
    
    # –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ GPT —Å –ø–æ—à–∞–≥–æ–≤—ã–º —Ä–∞—Å—á–µ—Ç–æ–º
    gpt_response = """
–ù–∞ —Ñ–æ—Ç–æ –º—è—Å–Ω–æ–µ –±–ª—é–¥–æ —Å –≥–∞—Ä–Ω–∏—Ä–æ–º: –∂–∞—Ä–µ–Ω—ã–µ –∫–æ—Ç–ª–µ—Ç—ã –∏–∑ –ø–µ—á–µ–Ω–∏, –æ—Ç–≤–∞—Ä–Ω–æ–π –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—É—Ä—Ü—ã, –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ—Ü, –ø–æ–º–∏–¥–æ—Ä—ã —á–µ—Ä—Ä–∏, –∑–µ–ª–µ–Ω—ã–π –ª—É–∫

–ö–æ—Ç–ª–µ—Ç—ã –∏–∑ –ø–µ—á–µ–Ω–∏ –∂–∞—Ä–µ–Ω—ã–µ ~150–≥: 172√ó1.5√ó1.2 = 310 –∫–∫–∞–ª, 25.5–≥ –±–µ–ª–∫–∞, 15–≥ –∂–∏—Ä–æ–≤, 3–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –æ—Ç–≤–∞—Ä–Ω–æ–π ~200–≥: 82√ó2.0 = 164 –∫–∫–∞–ª, 4–≥ –±–µ–ª–∫–∞, 0.8–≥ –∂–∏—Ä–æ–≤, 36–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–û–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ ~80–≥: 16√ó0.8 = 13 –∫–∫–∞–ª, 0.6–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 2.5–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ü–µ—Ä–µ—Ü –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π ~60–≥: 24√ó0.6 = 14 –∫–∫–∞–ª, 0.5–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 3–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ü–æ–º–∏–¥–æ—Ä—ã —á–µ—Ä—Ä–∏ ~50–≥: 18√ó0.5 = 9 –∫–∫–∞–ª, 0.5–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 1.5–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ó–µ–ª–µ–Ω—ã–π –ª—É–∫ ~20–≥: 19√ó0.2 = 4 –∫–∫–∞–ª, 0.3–≥ –±–µ–ª–∫–∞, 0–≥ –∂–∏—Ä–æ–≤, 0.8–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 514 –∫–∫–∞–ª, 31.4 –≥ –±–µ–ª–∫–∞, 15.8 –≥ –∂–∏—Ä–æ–≤, 46.8 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
"""
    
    result = extract_nutrition_smart(gpt_response)
    
    print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:")
    print(f"   –ö–∞–ª–æ—Ä–∏–∏: {result['calories']}")
    print(f"   –ë–µ–ª–∫–∏: {result['protein']}–≥")
    print(f"   –ñ–∏—Ä—ã: {result['fat']}–≥")
    print(f"   –£–≥–ª–µ–≤–æ–¥—ã: {result['carbs']}–≥")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ò–¢–û–ì–û–í–´–ï –∑–Ω–∞—á–µ–Ω–∏—è, –∞ –Ω–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ
    assert result['calories'] == 514, f"–û–∂–∏–¥–∞–ª–æ—Å—å 514 –∫–∫–∞–ª, –ø–æ–ª—É—á–µ–Ω–æ {result['calories']}"
    assert result['protein'] == 31.4, f"–û–∂–∏–¥–∞–ª–æ—Å—å 31.4–≥ –±–µ–ª–∫–∞, –ø–æ–ª—É—á–µ–Ω–æ {result['protein']}–≥"
    assert result['fat'] == 15.8, f"–û–∂–∏–¥–∞–ª–æ—Å—å 15.8–≥ –∂–∏—Ä–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['fat']}–≥"
    assert result['carbs'] == 46.8, f"–û–∂–∏–¥–∞–ª–æ—Å—å 46.8–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['carbs']}–≥"
    
    print("‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ë–ñ–£ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")


def test_extract_without_itogo_section():
    """
    –¢–µ—Å—Ç –Ω–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ë–ñ–£ –∫–æ–≥–¥–∞ –Ω–µ—Ç —è–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –ò–¢–û–ì–û
    """
    
    gpt_response = """
–ù–∞ —Ñ–æ—Ç–æ —Ç–≤–æ—Ä–æ–≥ —Å –±–∞–Ω–∞–Ω–æ–º –∏ –∞—Ä–∞—Ö–∏—Å–æ–≤–æ–π –ø–∞—Å—Ç–æ–π

–ü–æ—Ä—Ü–∏—è —Ç–≤–æ—Ä–æ–≥–∞ 5% 150–≥ –¥–∞—ë—Ç 121√ó1.5 = 182 –∫–∫–∞–ª, 17–≥ –±–µ–ª–∫–∞, 7.5–≥ –∂–∏—Ä–æ–≤, 4.5–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ë–∞–Ω–∞–Ω —Å—Ä–µ–¥–Ω–∏–π 120–≥: 96√ó1.2 = 115 –∫–∫–∞–ª, 1.2–≥ –±–µ–ª–∫–∞, 0.4–≥ –∂–∏—Ä–æ–≤, 26.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤  
–ê—Ä–∞—Ö–∏—Å–æ–≤–∞—è –ø–∞—Å—Ç–∞ 20–≥: 588√ó0.2 = 118 –∫–∫–∞–ª, 5–≥ –±–µ–ª–∫–∞, 10–≥ –∂–∏—Ä–æ–≤, 3.2–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–û–±—â–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å 415 –∫–∫–∞–ª, 23.2 –≥ –±–µ–ª–∫–∞, 17.9 –≥ –∂–∏—Ä–æ–≤, 34.1 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
"""
    
    result = extract_nutrition_smart(gpt_response)
    
    print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–µ–∑ –ò–¢–û–ì–û:")
    print(f"   –ö–∞–ª–æ—Ä–∏–∏: {result['calories']}")
    print(f"   –ë–µ–ª–∫–∏: {result['protein']}–≥")
    print(f"   –ñ–∏—Ä—ã: {result['fat']}–≥")
    print(f"   –£–≥–ª–µ–≤–æ–¥—ã: {result['carbs']}–≥")
    
    # –î–æ–ª–∂–Ω—ã –∏–∑–≤–ª–µ—á—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ (–∏—Ç–æ–≥–æ–≤—ã–µ) –∑–Ω–∞—á–µ–Ω–∏—è
    assert result['calories'] == 415, f"–û–∂–∏–¥–∞–ª–æ—Å—å 415 –∫–∫–∞–ª, –ø–æ–ª—É—á–µ–Ω–æ {result['calories']}"
    assert result['protein'] == 23.2, f"–û–∂–∏–¥–∞–ª–æ—Å—å 23.2–≥ –±–µ–ª–∫–∞, –ø–æ–ª—É—á–µ–Ω–æ {result['protein']}–≥"
    assert result['fat'] == 17.9, f"–û–∂–∏–¥–∞–ª–æ—Å—å 17.9–≥ –∂–∏—Ä–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['fat']}–≥"
    assert result['carbs'] == 34.1, f"–û–∂–∏–¥–∞–ª–æ—Å—å 34.1–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['carbs']}–≥"
    
    print("‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ë–ñ–£ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ –æ–±—â–µ–π –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏!")


def test_problematic_case_400_kcal():
    """
    –¢–µ—Å—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Å–ª—É—á–∞–π: 400 –∫–∫–∞–ª –Ω–æ 1.1–≥ –±–µ–ª–∫–∞
    –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–∑—è—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –∏—Ç–æ–≥–æ–≤—ã—Ö
    """
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –æ—Ç–≤–µ—Ç GPT
    gpt_response = """
–ù–∞ —Ñ–æ—Ç–æ –º—è—Å–Ω–æ–µ –±–ª—é–¥–æ —Å –≥–∞—Ä–Ω–∏—Ä–æ–º

–ö–æ—Ç–ª–µ—Ç—ã ~100–≥: 300 –∫–∫–∞–ª, 20–≥ –±–µ–ª–∫–∞, 15–≥ –∂–∏—Ä–æ–≤, 5–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å ~100–≥: 82 –∫–∫–∞–ª, 2–≥ –±–µ–ª–∫–∞, 0.2–≥ –∂–∏—Ä–æ–≤, 18–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–û–≤–æ—â–∏ ~50–≥: 18 –∫–∫–∞–ª, 1.1–≥ –±–µ–ª–∫–∞, 4.0–≥ –∂–∏—Ä–æ–≤, 2.0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 400 –∫–∫–∞–ª, 23.1 –≥ –±–µ–ª–∫–∞, 19.2 –≥ –∂–∏—Ä–æ–≤, 25.0 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
"""
    
    result = extract_nutrition_smart(gpt_response)
    
    print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞—è:")
    print(f"   –ö–∞–ª–æ—Ä–∏–∏: {result['calories']}")
    print(f"   –ë–µ–ª–∫–∏: {result['protein']}–≥")
    print(f"   –ñ–∏—Ä—ã: {result['fat']}–≥")
    print(f"   –£–≥–ª–µ–≤–æ–¥—ã: {result['carbs']}–≥")
    
    # –ù–ï –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 1.1–≥, 4.0–≥, 2.0–≥ - —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–≤–æ—â–µ–π
    assert result['protein'] != 1.1, "–û—à–∏–±–∫–∞! –í–∑—è—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–ª–∫–∞ –≤–º–µ—Å—Ç–æ –∏—Ç–æ–≥–æ–≤—ã—Ö"
    assert result['fat'] != 4.0, "–û—à–∏–±–∫–∞! –í–∑—è—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∂–∏—Ä–æ–≤ –≤–º–µ—Å—Ç–æ –∏—Ç–æ–≥–æ–≤—ã—Ö"
    assert result['carbs'] != 2.0, "–û—à–∏–±–∫–∞! –í–∑—è—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤–º–µ—Å—Ç–æ –∏—Ç–æ–≥–æ–≤—ã—Ö"
    
    # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–µ–∫—Ü–∏–∏ –ò–¢–û–ì–û
    assert result['protein'] == 23.1, f"–û–∂–∏–¥–∞–ª–æ—Å—å 23.1–≥ –±–µ–ª–∫–∞, –ø–æ–ª—É—á–µ–Ω–æ {result['protein']}–≥"
    assert result['fat'] == 19.2, f"–û–∂–∏–¥–∞–ª–æ—Å—å 19.2–≥ –∂–∏—Ä–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['fat']}–≥"
    assert result['carbs'] == 25.0, f"–û–∂–∏–¥–∞–ª–æ—Å—å 25.0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {result['carbs']}–≥"
    
    print("‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ù–ï –≤–∑—è—Ç—ã, –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏—Ç–æ–≥–æ–≤—ã–µ!")


if __name__ == '__main__':
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ë–ñ–£\n")
    
    print("=" * 60)
    print("–¢–ï–°–¢ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å —Å–µ–∫—Ü–∏–µ–π –ò–¢–û–ì–û")
    print("=" * 60)
    test_extract_final_values_from_detailed_response()
    
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–µ–∑ —Å–µ–∫—Ü–∏–∏ –ò–¢–û–ì–û")
    print("=" * 60)
    test_extract_without_itogo_section()
    
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 3: –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Å–ª—É—á–∞–π (400 –∫–∫–∞–ª, 1.1–≥ –±–µ–ª–∫–∞)")
    print("=" * 60)
    test_problematic_case_400_kcal()
    
    print("\n" + "=" * 60)
    print("‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
    print("=" * 60)
