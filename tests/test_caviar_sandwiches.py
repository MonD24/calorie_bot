# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∏–∫—Ä–æ–π
"""
import pytest
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from utils.photo_processor import extract_description_from_photo_response
from utils.calorie_calculator import extract_nutrition_smart


def test_caviar_sandwich_recognition():
    """–¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∏–∫—Ä–æ–π"""
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ GPT –¥–ª—è 6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∏–∫—Ä–æ–π
    gpt_response = """–ù–∞ —Ñ–æ—Ç–æ 6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä–æ–π - –ª–æ–º—Ç–∏–∫–∏ –±–µ–ª–æ–≥–æ —Ö–ª–µ–±–∞ —Å–æ —Å–ª–∏–≤–æ—á–Ω—ã–º —Å—ã—Ä–æ–º –∏ –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä–æ–π.

–ë–µ–ª—ã–π —Ö–ª–µ–± 6 –ª–æ–º—Ç–∏–∫–æ–≤ ~180–≥ (6√ó30–≥): 265√ó1.8 = 477 –∫–∫–∞–ª, 14.4–≥ –±–µ–ª–∫–∞, 5.4–≥ –∂–∏—Ä–æ–≤, 88.2–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–°—ã—Ä —Å–ª–∏–≤–æ—á–Ω—ã–π ~75–≥ (6√ó12–≥): 253√ó0.75 = 190 –∫–∫–∞–ª, 4.1–≥ –±–µ–ª–∫–∞, 18–≥ –∂–∏—Ä–æ–≤, 3.4–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞ ~135–≥ (6√ó22–≥): 252√ó1.35 = 340 –∫–∫–∞–ª, 33.2–≥ –±–µ–ª–∫–∞, 24.2–≥ –∂–∏—Ä–æ–≤, 0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 1007 –∫–∫–∞–ª, 51.7 –≥ –±–µ–ª–∫–∞, 47.6 –≥ –∂–∏—Ä–æ–≤, 91.6 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"""
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    description = extract_description_from_photo_response(gpt_response)
    assert '6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤' in description.lower() or '–±—É—Ç–µ—Ä–±—Ä–æ–¥' in description.lower()
    assert '–∏–∫—Ä' in description.lower()
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£
    nutrition = extract_nutrition_smart(gpt_response)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –æ–∫–æ–ª–æ 1000 –∫–∫–∞–ª (–Ω–µ 400!)
    assert nutrition['calories'] is not None
    assert nutrition['calories'] > 900, f"–ö–∞–ª–æ—Ä–∏–∏ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ: {nutrition['calories']}, –æ–∂–∏–¥–∞–ª–æ—Å—å >900"
    assert nutrition['calories'] < 1200, f"–ö–∞–ª–æ—Ä–∏–∏ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–µ: {nutrition['calories']}, –æ–∂–∏–¥–∞–ª–æ—Å—å <1200"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–ª–æ–∫
    assert nutrition['protein'] is not None
    assert nutrition['protein'] > 45, f"–ë–µ–ª–æ–∫ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π: {nutrition['protein']}, –æ–∂–∏–¥–∞–ª–æ—Å—å >45–≥"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–∏—Ä—ã
    assert nutrition['fat'] is not None
    assert nutrition['fat'] > 40, f"–ñ–∏—Ä—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ: {nutrition['fat']}, –æ–∂–∏–¥–∞–ª–æ—Å—å >40–≥"
    
    print(f"‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –ö–∞–ª–æ—Ä–∏–∏: {nutrition['calories']} –∫–∫–∞–ª, –ë–µ–ª–∫–∏: {nutrition['protein']}–≥, –ñ–∏—Ä—ã: {nutrition['fat']}–≥, –£–≥–ª–µ–≤–æ–¥—ã: {nutrition['carbs']}–≥")


def test_single_caviar_sandwich():
    """–¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –±—É—Ç–µ—Ä–±—Ä–æ–¥–∞ —Å –∏–∫—Ä–æ–π"""
    
    gpt_response = """–ù–∞ —Ñ–æ—Ç–æ 1 –±—É—Ç–µ—Ä–±—Ä–æ–¥ —Å –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä–æ–π - –±–µ–ª—ã–π —Ö–ª–µ–±, —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ, –∫—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞.

–ë–µ–ª—ã–π —Ö–ª–µ–± ~30–≥: 265√ó0.3 = 80 –∫–∫–∞–ª, 2.4–≥ –±–µ–ª–∫–∞, 0.9–≥ –∂–∏—Ä–æ–≤, 14.7–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ ~10–≥: 748√ó0.1 = 75 –∫–∫–∞–ª, 0.05–≥ –±–µ–ª–∫–∞, 8.3–≥ –∂–∏—Ä–æ–≤, 0.1–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
–ö—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞ ~20–≥: 252√ó0.2 = 50 –∫–∫–∞–ª, 4.9–≥ –±–µ–ª–∫–∞, 3.6–≥ –∂–∏—Ä–æ–≤, 0–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤

–ò–¢–û–ì–û: 205 –∫–∫–∞–ª, 7.35 –≥ –±–µ–ª–∫–∞, 12.8 –≥ –∂–∏—Ä–æ–≤, 14.8 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤"""
    
    nutrition = extract_nutrition_smart(gpt_response)
    
    assert nutrition['calories'] is not None
    assert 180 <= nutrition['calories'] <= 220, f"–ù–µ–≤–µ—Ä–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: {nutrition['calories']}"
    
    print(f"‚úÖ –¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ –±—É—Ç–µ—Ä–±—Ä–æ–¥–∞ –ø—Ä–æ–π–¥–µ–Ω! –ö–∞–ª–æ—Ä–∏–∏: {nutrition['calories']} –∫–∫–∞–ª")


def test_old_wrong_response():
    """–¢–µ—Å—Ç —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞ 100–≥)"""
    
    # –ò–º–∏—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    wrong_response = """–ù–∞ —Ñ–æ—Ç–æ –±—É—Ç–µ—Ä–±—Ä–æ–¥—ã —Å –∏–∫—Ä–æ–π: –±–µ–ª—ã–π —Ö–ª–µ–±, —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ, –∫—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞.

–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –Ω–∞ 100–≥: 400 –∫–∫–∞–ª, 15–≥ –±–µ–ª–∫–∞

–ò–¢–û–ì–û: 400 –∫–∫–∞–ª, 15 –≥ –±–µ–ª–∫–∞"""
    
    nutrition = extract_nutrition_smart(wrong_response)
    
    # –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤
    # –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, GPT –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    print(f"‚ö†Ô∏è –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: {nutrition['calories']} –∫–∫–∞–ª (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 900-1200 –¥–ª—è 5-6 –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤)")


if __name__ == "__main__":
    print("üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ —Å –∏–∫—Ä–æ–π...\n")
    
    test_caviar_sandwich_recognition()
    test_single_caviar_sandwich()
    test_old_wrong_response()
    
    print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!")
