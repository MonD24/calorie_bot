name: âœ… Simple CI Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  fast-tests:
    name: "Fast & Reliable Tests"
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: âš¡ Smoke Tests (Ultra Fast)
      run: python tests/test_smoke.py

    - name: ğŸ§ª CI Tests (Comprehensive)
      run: python tests/test_ci.py

    - name: ğŸ” Quick Import Check
      run: |
        echo "Testing critical imports..."
        python -c "import sys, os, re, json; print('âœ… Standard libs OK')"
        python -c "print('âœ… Python version:', sys.version)"

    - name: ğŸ“Š File Structure Check
      run: |
        echo "Checking project structure..."
        test -f calorie_bot_modular.py && echo "âœ… Main bot file exists"
        test -f config.py && echo "âœ… Config exists" 
        test -f requirements.txt && echo "âœ… Requirements exists"
        test -d utils && echo "âœ… Utils directory exists"
        test -d handlers && echo "âœ… Handlers directory exists"

  security-scan:
    name: "Security & Quality"
    runs-on: ubuntu-latest
    needs: fast-tests
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”’ Check for secrets
      run: |
        echo "ğŸ” Scanning for hardcoded secrets..."
        
        # Check for API keys
        if grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.md" 2>/dev/null; then
          echo "âŒ OpenAI API key found in code!"
          exit 1
        fi
        
        # Check for bot tokens  
        if grep -r "[0-9]\{8,\}:[a-zA-Z0-9_-]\{35\}" . --exclude-dir=.git --exclude="*.md" 2>/dev/null; then
          echo "âŒ Telegram bot token found in code!"
          exit 1
        fi
        
        echo "âœ… No hardcoded secrets detected"

    - name: ğŸ“ Basic code quality
      run: |
        echo "ğŸ“ Basic quality checks..."
        
        # Check for TODO/FIXME comments
        todo_count=$(grep -r "TODO\|FIXME" . --exclude-dir=.git --include="*.py" | wc -l || echo "0")
        echo "ğŸ“ Found $todo_count TODO/FIXME comments"
        
        # Check Python file syntax
        echo "ğŸ Checking Python syntax..."
        find . -name "*.py" -exec python -m py_compile {} \; 2>/dev/null || echo "âš ï¸ Some syntax issues found"
        
        echo "âœ… Quality check completed"

  summary:
    name: "Test Summary" 
    runs-on: ubuntu-latest
    needs: [fast-tests, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“‹ Results Summary
      run: |
        echo "ğŸ§ª TEST SUMMARY"
        echo "==============="
        echo ""
        
        if [ "${{ needs.fast-tests.result }}" = "success" ]; then
          echo "âœ… Fast Tests: PASSED"
        else
          echo "âŒ Fast Tests: FAILED"
        fi
        
        if [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "âœ… Security: PASSED"
        else  
          echo "âŒ Security: FAILED"
        fi
        
        echo ""
        
        if [ "${{ needs.fast-tests.result }}" = "success" ] && [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "ğŸ‰ ALL CHECKS PASSED!"
          echo "âœ¨ Code is ready for production"
        else
          echo "ğŸ”§ Issues found - please fix before merging"
          exit 1
        fi
