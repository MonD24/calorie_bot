name: ğŸš€ Release Tests

on:
  release:
    types: [published, prereleased]
  workflow_dispatch: # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  comprehensive-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock flake8 bandit[toml]

    - name: ğŸ§ª Run all unit tests
      run: |
        echo "ğŸ§ª Testing BJU extraction..."
        python test_bju_extraction.py
        
        echo "ğŸ§ª Testing photo response analysis..."
        python test_photo_response.py
        
        echo "ğŸ§ª Testing nutrition validation..."
        python test_validation.py

    - name: ğŸ“Š Generate test coverage report
      run: |
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ coverage Ñ‚ĞµÑÑ‚
        python -c "
        import sys
        import importlib.util
        
        modules_to_test = [
            'utils.calorie_calculator',
            'utils.photo_processor', 
            'utils.nutrition_validator',
            'handlers.commands',
            'data.calorie_database'
        ]
        
        tested_modules = 0
        for module in modules_to_test:
            try:
                spec = importlib.util.find_spec(module)
                if spec is not None:
                    tested_modules += 1
                    print(f'âœ… {module}')
                else:
                    print(f'âŒ {module} - not found')
            except Exception as e:
                print(f'âŒ {module} - error: {e}')
        
        coverage = (tested_modules / len(modules_to_test)) * 100
        print(f'\nğŸ“Š Module Coverage: {coverage:.1f}% ({tested_modules}/{len(modules_to_test)})')
        
        if coverage < 80:
            sys.exit(1)
        "

    - name: ğŸ” Advanced syntax and style check
      run: |
        echo "ğŸ” Running flake8..."
        flake8 --max-line-length=120 --statistics \
          --ignore=E501,W503,E203,F401 \
          calorie_bot_modular.py utils/ handlers/ data/ \
          --exclude=__pycache__,*.pyc

    - name: ğŸ”’ Security audit
      run: |
        echo "ğŸ”’ Running security check..."
        bandit -r . -ll -f txt || true

    - name: ğŸ“‹ Environment compatibility test
      run: |
        echo "ğŸ“‹ Testing in different environments..."
        
        # Ğ¢ĞµÑÑ‚ Ğ±ĞµĞ· .env Ñ„Ğ°Ğ¹Ğ»Ğ°
        rm -f .env
        python -c "import config; print('âœ… Config works without .env')" || echo "âš ï¸ Config requires .env"
        
        # Ğ¢ĞµÑÑ‚ Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑĞ¼Ğ¸
        echo "ğŸ“¦ Testing core functionality..."
        python -c "
        from utils.calorie_calculator import extract_nutrition_smart
        result = extract_nutrition_smart('Ğ¢ĞµÑÑ‚ 100 ĞºĞºĞ°Ğ», 10Ğ³ Ğ±ĞµĞ»ĞºĞ°, 5Ğ³ Ğ¶Ğ¸Ñ€Ğ°, 8Ğ³ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ²')
        assert result['calories'] == 100
        assert result['protein'] == 10.0
        print('âœ… Core extraction works')
        "

  performance-test:
    runs-on: ubuntu-latest
    needs: comprehensive-test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âš¡ Performance tests
      run: |
        python -c "
        import time
        from utils.calorie_calculator import extract_nutrition_smart
        
        # Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ‘Ğ–Ğ£
        test_cases = [
            'Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³ 200 ĞºĞºĞ°Ğ», 25Ğ³ Ğ±ĞµĞ»ĞºĞ°, 5Ğ³ Ğ¶Ğ¸Ñ€Ğ°, 10Ğ³ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ²',
            'Ğ¡Ğ°Ğ»Ğ°Ñ‚ Ñ ĞºÑƒÑ€Ğ¸Ñ†ĞµĞ¹: 300 ĞºĞºĞ°Ğ», Ğ±ĞµĞ»ĞºĞ¸ 30Ğ³, Ğ¶Ğ¸Ñ€Ñ‹ 8Ğ³, ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ 15Ğ³',
            'Ğ Ğ¸Ñ Ñ Ğ¾Ğ²Ğ¾Ñ‰Ğ°Ğ¼Ğ¸\\nâ€¢ ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸: 250\\nâ€¢ Ğ‘ĞµĞ»Ğ¾Ğº: 8Ğ³\\nâ€¢ Ğ–: 2Ğ³\\nâ€¢ Ğ£: 50Ğ³'
        ] * 100  # 300 Ñ‚ĞµÑÑ‚Ğ¾Ğ²
        
        start_time = time.time()
        
        for i, test_case in enumerate(test_cases):
            result = extract_nutrition_smart(test_case)
            if i % 100 == 0:
                print(f'Processed {i} cases...')
        
        end_time = time.time()
        total_time = end_time - start_time
        avg_time = total_time / len(test_cases)
        
        print(f'âš¡ Performance Results:')
        print(f'   Total time: {total_time:.2f}s')
        print(f'   Average per extraction: {avg_time*1000:.2f}ms')
        print(f'   Extractions per second: {1/avg_time:.1f}')
        
        if avg_time > 0.1:  # Ğ‘Ğ¾Ğ»ĞµĞµ 100ms Ğ½Ğ° Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ - ÑÑ‚Ğ¾ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾
            print('âš ï¸ Performance warning: extraction is slow')
        else:
            print('âœ… Performance is good')
        "

  notify-success:
    runs-on: ubuntu-latest
    needs: [comprehensive-test, performance-test]
    if: success()
    
    steps:
    - name: âœ… All tests passed
      run: |
        echo "ğŸ‰ All release tests passed successfully!"
        echo "âœ… Unit tests: PASSED"
        echo "âœ… Integration tests: PASSED" 
        echo "âœ… Security checks: PASSED"
        echo "âœ… Performance tests: PASSED"
        echo ""
        echo "ğŸš€ Ready for deployment!"
