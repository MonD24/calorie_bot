name: ğŸ” Pull Request Check

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]

jobs:
  quick-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
        
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Quick syntax check
      run: |
        echo "ğŸ” Checking syntax of changed files..."
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ñ… Python Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        git diff --name-only origin/master...HEAD | grep "\.py$" | while read file; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            python -m py_compile "$file"
          fi
        done

    - name: ğŸ§ª Run fast CI tests
      run: |
        echo "ğŸ§ª Running reliable CI tests..."
        python tests/test_ci.py

    - name: ğŸ“Š Check for regression
      run: |
        echo "ğŸ” Checking for potential regressions..."
        python -c "
        from utils.calorie_calculator import extract_nutrition_smart
        
        # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¸
        test_cases = [
            ('450 ĞºĞºĞ°Ğ», 30Ğ³ Ğ±ĞµĞ»ĞºĞ°, 15Ğ³ Ğ¶Ğ¸Ñ€Ğ°, 25Ğ³ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ²', 450),
            ('ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸: 200, Ğ±ĞµĞ»ĞºĞ¸: 20Ğ³', 200),
            ('Ğ¡Ğ°Ğ»Ğ°Ñ‚ 300 ĞºĞºĞ°Ğ»', 300)
        ]
        
        for text, expected_cal in test_cases:
            result = extract_nutrition_smart(text)
            if result['calories'] != expected_cal:
                print(f'âŒ Regression detected: {text} -> {result['calories']} (expected {expected_cal})')
                exit(1)
        
        print('âœ… No regressions detected')
        "

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
        
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ Install dev dependencies
      run: |
        pip install flake8 bandit

    - name: ğŸ“ Code style check
      run: |
        echo "ğŸ“ Running flake8..."
        flake8 --max-line-length=120 --ignore=E501,W503,E203 \
          --statistics --count \
          calorie_bot_modular.py utils/ handlers/ data/ \
          --exclude=__pycache__,*.pyc || true

    - name: ğŸ”’ Security check
      run: |
        echo "ğŸ”’ Running security scan..."
        bandit -r . -f txt -ll || true
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ½ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
        echo "ğŸ” Checking for hardcoded secrets..."
        if git diff origin/master...HEAD | grep -E "(api[_-]?key|token|password|secret)" -i; then
          echo "âš ï¸ Potential secrets found in diff"
        else
          echo "âœ… No secrets detected in changes"
        fi

  pr-summary:
    runs-on: ubuntu-latest
    needs: [quick-check, code-quality]
    if: always()
    
    steps:
    - name: ğŸ“‹ PR Check Summary
      run: |
        echo "ğŸ“‹ Pull Request Check Summary"
        echo "=========================="
        echo ""
        
        if [ "${{ needs.quick-check.result }}" = "success" ]; then
          echo "âœ… Quick Check: PASSED"
        else
          echo "âŒ Quick Check: FAILED"
        fi
        
        if [ "${{ needs.code-quality.result }}" = "success" ]; then
          echo "âœ… Code Quality: PASSED"  
        else
          echo "âŒ Code Quality: FAILED"
        fi
        
        echo ""
        if [ "${{ needs.quick-check.result }}" = "success" ] && [ "${{ needs.code-quality.result }}" = "success" ]; then
          echo "ğŸ‰ PR is ready for review!"
        else
          echo "ğŸ”§ PR needs fixes before merge"
          exit 1
        fi
